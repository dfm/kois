#!/usr/bin/env python
# -*- coding: utf-8 -*-

import os
import sqlite3
import logging
import argparse
import subprocess
from datetime import datetime
from ConfigParser import ConfigParser

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Build a KOI model")
    parser.add_argument("koi_id", help="The KOI number")
    parser.add_argument("config", help="Path to the configuration file")
    args = parser.parse_args()
    logging.basicConfig(level=logging.INFO)
    koi_id = args.koi_id

    # Parse the configuration file.
    config = ConfigParser()
    config.read(args.config)

    # Set up the output directory.
    outdir = os.path.join(config.get("local", "basepath"), koi_id)

    # Copy the precomputed model.
    files = map(lambda f: "{0}:{1}"
                .format(config.get("remote", "hostname"),
                        os.path.join(config.get("remote", "basepath"),
                                     koi_id, f)),
                ["model.pkl", "mcmc.h5"])
    cmd = "scp {0} {1}".format(" ".join(files), outdir)
    logging.info("Running command:")
    logging.info("    {0}".format(cmd))
    subprocess.check_call(cmd, shell=True)

    # Update the database.
    with sqlite3.connect(config.get("local", "database")) as conn:
        c = conn.cursor()
        c.execute("update kois set fetched=? where kepoi_name=?",
                  (datetime.now(), koi_id))
