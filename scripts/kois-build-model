#!/usr/bin/env python
# -*- coding: utf-8 -*-

import os
import kplr
import logging
import numpy as np
import cPickle as pickle

import kois

if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(description="Build a KOI model")
    parser.add_argument("koi", type=int, help="The KOI ID")
    parser.add_argument("-o", "--outdir", default=None,
                        help="The directory where the output files will be "
                        "written")
    parser.add_argument("--plots", action="store_true",
                        help="Make some basic figures")
    parser.add_argument("--pbs", action="store_true",
                        help="Generate the PBS script")
    parser.add_argument("--submit", action="store_true",
                        help="Submit the job to the bowery cluster")
    args = parser.parse_args()

    logging.basicConfig(level=logging.INFO)

    # Set up the output directory.
    outdir = args.outdir
    if outdir is None:
        outdir = "models"
    outdir = os.path.join(outdir, "koi-{0}".format(args.koi))
    try:
        os.makedirs(outdir)
    except os.error:
        logging.info("Output directory '{0}' exists".format(outdir))

    model = kois.load_system(args.koi)
    pickle.dump(model, open(os.path.join(outdir, "model.pkl"), "wb"), -1)
    ndim = len(model.vector)
    nodes = int(max(np.ceil(ndim/12.0), 2))
    nwalkers = 24 * nodes
    logging.info("Sampling {0} parameters with {1} walkers".format(ndim, nwalkers))
    logging.info("    ({0} planets)".format(len(model.periods)))

    if args.pbs or args.submit:
        cpus = nodes * 12
        script = """#!/bin/bash

#PBS -l nodes={nodes}:ppn=12,walltime=8:00:00
#PBS -q p12
#PBS -N koi{koi}
#PBS -M dfm265@nyu.edu
#PBS -m abe
#PBS -e localhost:$PBS_O_WORKDIR/${{PBS_JOBNAME}}.e${{PBS_JOBID}}
#PBS -o localhost:$PBS_O_WORKDIR/${{PBS_JOBNAME}}.o${{PBS_JOBID}}

cd /scratch/dfm265/kois/koi-{koi}

export PYTHONPATH=/home/dfm265/projects/kois/:$PYTHONPATH

mpiexec -np {cpus} /share/apps/mpi4py/1.3/openmpi/intel/lib/python2.7/site-packages/mpi4py/bin/python-mpi /home/dfm265/projects/kois/scripts/kois-run-mcmc model.pkl --nwalkers {nwalkers} &> output.log

exit 0;
""".format(nodes=nodes, cpus=cpus, koi=args.koi, nwalkers=nwalkers)

        with open(os.path.join(outdir, "job.pbs"), "w") as f:
            f.write(script)

    if args.submit:
        import subprocess

        # Copy the precomputed model.
        cmd = "scp -r {0} bowery:/scratch/dfm265/kois/".format(outdir)
        logging.info("Running command:")
        logging.info("    {0}".format(cmd))
        subprocess.check_call(cmd, shell=True)

        # Queue the job.
        cmd = ("ssh bowery \"qsub /scratch/dfm265/kois/koi-{0}/job.pbs\""
               .format(args.koi))
        logging.info("Running command:")
        logging.info("    {0}".format(cmd))
        subprocess.check_call(cmd, shell=True)

    if args.plots:
        import matplotlib.pyplot as pl

        logging.info("Generating folded light curve plots with initial model")

        nplanets = len(model.periods)

        for i, (P, t0, dur) in enumerate(zip(model.periods, model.epochs,
                                             model.durations)):
            fig, axes = pl.subplots(2, 1, figsize=(6, 6),
                                    sharex=True)
            fig.subplots_adjust(left=0.17, bottom=0.1, right=0.9,
                                top=0.9, wspace=0.05, hspace=0.05)

            # Plot the folded datasets.
            hp = 0.5 * P
            for d in model.datasets:
                ax = axes[0]
                if d.texp < 0.01:
                    ax = axes[1]
                ax.plot((d.time-t0+hp) % P - hp, d.flux, ".k", alpha=0.3, ms=3)

            # Plot the models.
            t = np.linspace(-4*dur, 4*dur, 1000)
            lc = kplr.EXPOSURE_TIMES[1]/86400.0
            axes[0].plot(t, model.get_light_curve(t+t0, K=5, texp=lc), "r",
                         lw=2)
            sc = kplr.EXPOSURE_TIMES[0]/86400.0
            axes[1].plot(t, model.get_light_curve(t+t0, K=3, texp=sc), "r",
                         lw=2)

            # Set the y-axis limits.
            for ax in axes:
                ylim = min(ax.get_ylim()[0] - 1, -1e-3)
                ax.set_ylim(1+1.2*ylim, 1-0.6*ylim)

            # Labels.
            axes[0].set_xlim(-4*dur, 4*dur)
            axes[0].set_title("KOI {0}.{1:02d}, period = {2} days"
                              .format(args.koi, i+1, P))
            axes[1].set_xlabel("time since transit")
            fig.savefig(os.path.join(outdir,
                                     "light-curve-{0}.{1:02d}.png"
                                     .format(args.koi, i+1)))
